#jinja2: trim_blocks: "true", lstrip_blocks: "true"
# {{ ansible_managed }}

[global]
{% if not cephx %}
auth_cluster_required = none
auth_service_required = none
auth_client_required = none
auth_supported = none
{% endif %}
{% if not mon_containerized_deployment_with_kv and not mon_containerized_deployment %}
fsid = {{ fsid }}
{% endif %}
max_open_files = {{ max_open_files }}
{% if common_single_host_mode is defined and common_single_host_mode %}
osd_crush_chooseleaf_type = 0
{% endif %}
{# NOTE (leseb): the blank lines in-between are needed otherwise we won't get any line break #}
{% if groups[mon_group_name] is defined %}
mon_initial_members = {% for host in groups[mon_group_name] %}
      {% if hostvars[host]['ansible_fqdn'] is defined and mon_use_fqdn -%}
        {{ hostvars[host]['ansible_fqdn'] }}
      {%- elif hostvars[host]['ansible_hostname'] is defined -%}
        {{ hostvars[host]['ansible_hostname'] }}
      {%- endif %}
      {%- if not loop.last %},{% endif %}
    {% endfor %}
{% endif %}

{% if not mon_containerized_deployment and not mon_containerized_deployment_with_kv %}
{% if monitor_address_block %}
mon_host = {% for host in groups[mon_group_name] %}{{ hostvars[host]['ansible_all_ipv4_addresses'] | ipaddr(monitor_address_block) | first }}{% if not loop.last %},{% endif %}{% endfor %}
{% elif groups[mon_group_name] is defined %}
mon_host = {% for host in groups[mon_group_name] %}
             {% set address = hostvars[host]['monitor_address'] if hostvars[host]['monitor_address'] is defined else monitor_address %}
             {% set interface = hostvars[host]['monitor_interface'] if hostvars[host]['monitor_interface'] is defined else monitor_interface %}
             {% if interface != "interface" %}
               {% for key in hostvars[host].keys() %}
                 {% if hostvars[host][key]['macaddress'] is defined and hostvars[host][key]['device'] is defined and hostvars[host][key]['device'] == interface -%}
                    {{ hostvars[host][key]['ipv4']['address'] }}
                 {%- endif %}
               {% endfor %}
             {% elif address != "0.0.0.0" -%}
               {{ address }}
             {%- endif %}
             {%- if not loop.last %},{% endif %}
           {% endfor %}
{% endif %}
{% endif %}
{% if mon_containerized_deployment %}
fsid = {{ fsid }}
{% if groups[mon_group_name] is defined %}
mon_host = {% for host in groups[mon_group_name] %}
             {% set interface = ["ansible_",ceph_mon_docker_interface]|join %}
             {% if mon_containerized_deployment -%}
                {{ hostvars[host][interface]['ipv4']['address'] }}
             {%- elif hostvars[host]['monitor_address'] is defined -%}
                {{ hostvars[host]['monitor_address'] }}
             {%- elif monitor_address != "0.0.0.0" -%}
                {{ monitor_address }}
             {%- endif %}
             {%- if not loop.last %},{% endif %}
           {% endfor %}
{% endif %}
{% endif %}

{% if public_network is defined %}
public_network = {{ public_network }}
{% endif %}
{% if cluster_network is defined %}
cluster_network = {{ cluster_network }}
{% endif %}


{% include 'global.conf.j2' %}

{% include 'mon.conf.j2' %}

[osd]
osd_mkfs_type = {{ osd_mkfs_type }}
osd_mkfs_options xfs = {{ osd_mkfs_options_xfs }}
osd_mount_options xfs = {{ osd_mount_options_xfs }}
osd_journal_size = {{ journal_size }}
{% if filestore_xattr_use_omap != None %}
filestore_xattr_use_omap = {{ filestore_xattr_use_omap }}
{% elif osd_mkfs_type == "ext4" %}
filestore_xattr_use_omap = true
{# else, default is false #}
{% endif %}

{% include 'osd.conf.j2' %}

{% include 'client.conf.j2' %}


{% if groups[mds_group_name] is defined %}
{% for host in groups[mds_group_name] %}
{% if hostvars[host]['ansible_fqdn'] is defined and mds_use_fqdn %}
[mds.{{ hostvars[host]['ansible_fqdn'] }}]
host = {{ hostvars[host]['ansible_fqdn'] }}
{% elif hostvars[host]['ansible_hostname'] is defined %}
[mds.{{ hostvars[host]['ansible_hostname'] }}]
host = {{ hostvars[host]['ansible_hostname'] }}
{% endif %}
{% endfor %}
{% endif %}


{% if rgw1 is defined %}                                                                        
[client.rgw.{{ rgw1['instance_name'] }}]                                                        
host = {{ ansible_hostname }}                                                                   
keyring = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw1['instance_name'] }}/keyring           
log_file = /var/log/ceph/{{ cluster }}-rgw-{{ rgw1['instance_name'] }}.log                      
rgw_data = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw1['instance_name'] }}                  
rgw_frontends = "civetweb port={{ rgw1['radosgw_civetweb_port'] }}"                             
{% if rgw1['rgw_enable_usage_log'] is defined %}rgw_enable_usage_log = {{ rgw1['rgw_enable_usage_log'] }}                                       
{% endif %}                                                                                     
{% endif %}                                                                                     
                                                                                                
{% if rgw2 is defined %}                                                                        
[client.rgw.{{ rgw2['instance_name'] }}]                                                        
host = {{ ansible_hostname }}                                                                   
keyring = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw2['instance_name'] }}/keyring           
log_file = /var/log/ceph/{{ cluster }}-rgw-{{ rgw2['instance_name'] }}.log                      
rgw_data = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw2['instance_name'] }}                  
rgw_frontends = "civetweb port={{ rgw2['radosgw_civetweb_port'] }}"                             
{% if rgw2['rgw_enable_usage_log'] is defined %}rgw_enable_usage_log = {{ rgw2['rgw_enable_usage_log'] }}                                       
{% endif %}                                                                                     
{% endif %}                                                                                     
                                                                                                
{% if rgw3 is defined %}                                                                        
[client.rgw.{{ rgw3['instance_name'] }}]                                                        
host = {{ ansible_hostname }}                                                                   
keyring = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw3['instance_name'] }}/keyring           
log_file = /var/log/ceph/{{ cluster }}-rgw-{{ rgw3['instance_name'] }}.log                      
rgw_data = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw3['instance_name'] }}                  
rgw_frontends = "civetweb port={{ rgw3['radosgw_civetweb_port'] }}"                             
{% if rgw3['rgw_enable_usage_log'] is defined %}rgw_enable_usage_log = {{ rgw3['rgw_enable_usage_log'] }}                                       
{% endif %}                                                                                     
{% endif %}                                                                                     
                                                                                                
{% if rgw4 is defined %}                                                                        
[client.rgw.{{ rgw4['instance_name'] }}]                                                        
host = {{ ansible_hostname }}                                                                   
keyring = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw4['instance_name'] }}/keyring           
log_file = /var/log/ceph/{{ cluster }}-rgw-{{ rgw4['instance_name'] }}.log                      
rgw_data = /var/lib/ceph/radosgw/{{ cluster }}-rgw.{{ rgw4['instance_name'] }}                  
rgw_frontends = "civetweb port={{ rgw4['radosgw_civetweb_port'] }}"                             
{% if rgw4['rgw_enable_usage_log'] is defined %}rgw_enable_usage_log = {{ rgw4['rgw_enable_usage_log'] }}                                       
{% endif %}                                                                                     
{% endif %}                                                                                     
