# 部署
```
ansible-playbook site.yml -v -i inventory  --extra-vars  \
'{"ceph_stable": true, \ 
"ceph_origin": "distro", \
"monitor_interface": "bond1", \
"journal_collocation": true, \
"journal_size": 10240, \
"public_network": "192.168.10.0/24", \
"cluster_network": "192.168.10.0/24", \
"cephx": true, \
"ntp_service_enabled": "false", \
"osd_crush_tunables_optimal": true \
}' -u onest -f 200
```

# 更新mon的脚本update_cephconf_mon.sh
```
ansible-playbook push_conf_mon.yml -v  -i  inventory  --extra-vars \
'{"monitor_interface": "bond1", \
"journal_size": 10240, \
"public_network": "192.168.10.0/24", \
"cluster_network": "192.168.10.0/24", \
"osd_crush_tunables_optimal": true , \
"fsid":"5396edbb-af1f-4042-9998-2063e1c21b35" \
}' -u onest -f 200
```
其中 push_conf_mon.yml 如下：

```
[onest@NFJD-PSC-oNest-Mst-SV1 ceph-ansible]$ cat push_conf_mon.yml 
---
# push ceph.conf to nodes
# Need to load the facts from mons because ceph-common need them to generate the ceph.conf
- hosts:
    - mons
  become: True
  roles:
    - { role: ceph-push-conf }
  vars:
    - devices: []
```
执行更新
```
chmod +x update_cephconf_mon.sh &&　./update_cephconf_mon.sh
```


# 更新osd的脚本update_cephconf_osd.sh
```
ansible-playbook push_conf_osd.yml -v  -i  inventory  --extra-vars \
'{"monitor_interface": "bond1", \
"journal_size": 10240, \
"public_network": "192.168.10.0/24", \
"cluster_network": "192.168.10.0/24", \
"osd_crush_tunables_optimal": true , \
"fsid":"5396edbb-af1f-4042-9998-2063e1c21b35" \
}' -u onest -f 200
```
其中 push_conf_osd.yml 如下：

```
[onest@NFJD-PSC-oNest-Mst-SV1 ceph-ansible]$ cat push_conf_osd.yml 
---
# push ceph.conf to nodes
# Need to load the facts from mons because ceph-common need them to generate the ceph.conf
- hosts:
    - osds
  become: True
  roles:
    - { role: ceph-push-conf }
  vars:
    - devices: []
```
执行更新
```
chmod +x update_cephconf_osd.sh &&　./update_cephconf_osd.sh
```


# 更新osd的脚本update_cephconf_rgw.sh
```
ansible-playbook push_conf_rgw.yml -v  -i  inventory  --extra-vars \
'{"monitor_interface": "bond1", \
"journal_size": 10240, \
"public_network": "192.168.10.0/24", \
"cluster_network": "192.168.10.0/24", \
"osd_crush_tunables_optimal": true , \
"fsid":"5396edbb-af1f-4042-9998-2063e1c21b35" \
}' -u onest -f 200
```

其中 push_conf_osd.yml 如下：

```
[onest@NFJD-PSC-oNest-Mst-SV1 ceph-ansible]$ cat push_conf_rgw.yml 
---
# push ceph.conf to nodes
# Need to load the facts from mons because ceph-common need them to generate the ceph.conf
- hosts:
    - rgws
  become: True
  roles:
    - { role: ceph-push-conf }
  vars:
    - devices: []
```
执行更新
```
chmod +x update_cephconf_rgw.sh &&　./update_cephconf_rgw.sh
```

# lo网卡绑定vip

rgws组机器所有的机器上的lo网卡绑定3个vip:192.168.10.244,192.168.10.220,192.168.10.221
```
site.yml
---
- hosts: rgws
  vars:
    cephvips: ["192.168.10.244","192.168.10.220","192.168.10.221"]
  roles:
    - lvs
	
inventory文件
[rgws]
192.168.10.100

部署
ansible-playbook -i inventory site.yml -u root 
```


# 配置互为主备keepalived


```
例子：
192.168.153.168 
192.168.153.169
两台上安装keepalived+lvs,192.168.153.168为vi2的主,vi1的备。192.168.153.169为vi1的主,vi2的备
vi1的vip是192.168.153.222
vi2的vip是192.168.153.223
配置2个端口组，80和7480。每个端口的后端的realserver组可以在real_servers数组中配置
```

```
vi1(vi1的vip是192.168.153.222)       master           backup
                                192.168.153.169    192.168.153.168
vi2(vi2的vip是192.168.153.223)       master           backup
                                192.168.153.168    192.168.153.169
```
host_vars

```
#192.168.153.168
---
master: 'vi2'   #对于vrrp instance vi2来说 192.168.153.168机器是master 

#192.168.153.169
---
master: 'vi1'   #对于vrrp instance vi1来说 192.168.153.169机器是master 

```

```
site.yml
---
- hosts: test
  become: True
  vars:
    - vrrp_instances: [
    {name: 'vi1',vip: '192.168.153.222',virtual_router_id: '222'},
    {name: 'vi2',vip: '192.168.153.223',virtual_router_id: '223'}
    ]
    - vrrp_instances_devices: 'ens33'
    - virtual_server_groups: [
    {name: 'RGW_BUSINESS_80', vips: ['192.168.153.222','192.168.153.223'], port: '80',real_servers: ['192.168.153.156']},
    {name: 'RGW_BUSINESS_7480', vips: ['192.168.153.222','192.168.153.223'], port: '7480',real_servers: ['192.168.153.156']}
    ]
  roles:
  - serv-keepalived
 
inventory文件
[test]
192.168.153.168
192.168.153.169

#部署
ansible-playbook -i inventory site.yml -u root 
```

